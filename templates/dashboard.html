{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block extra_css %}
<style>
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        display: flex;
        align-items: center;
        gap: 20px;
        transition: transform 0.3s;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
    }

    .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
    }

    .stat-icon.blue { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .stat-icon.orange { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .stat-icon.green { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .stat-icon.red { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
    .stat-icon.purple { background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); }
    .stat-icon.teal { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }

    .stat-details {
        flex: 1;
    }

    .stat-value {
        font-size: 32px;
        font-weight: bold;
        color: #2c3e50;
    }

    .stat-label {
        color: #7f8c8d;
        font-size: 14px;
        margin-top: 5px;
    }

    .content-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    .card {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f5f7fa;
    }

    .card-title {
        font-size: 18px;
        font-weight: 600;
        color: #2c3e50;
    }

    .table {
        width: 100%;
        border-collapse: collapse;
    }

    .table th {
        text-align: left;
        padding: 12px;
        background: #f8f9fa;
        color: #7f8c8d;
        font-weight: 600;
        font-size: 13px;
        text-transform: uppercase;
    }

    .table td {
        padding: 12px;
        border-bottom: 1px solid #ecf0f1;
    }

    .table tr:hover {
        background: #f8f9fa;
    }

    .badge {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }

    .badge-success { background: #d4edda; color: #155724; }
    .badge-warning { background: #fff3cd; color: #856404; }
    .badge-danger { background: #f8d7da; color: #721c24; }
    .badge-info { background: #d1ecf1; color: #0c5460; }

    .alert-item {
        padding: 15px;
        border-left: 4px solid #f39c12;
        background: #fff9e6;
        border-radius: 8px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .alert-text {
        flex: 1;
    }

    .alert-title {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 3px;
    }

    .alert-desc {
        font-size: 13px;
        color: #7f8c8d;
    }

    @media (max-width: 968px) {
        .content-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon blue">üì¶</div>
        <div class="stat-details">
            <div class="stat-value" id="totalProducts">0</div>
            <div class="stat-label">Total Products</div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon orange">‚ö†Ô∏è</div>
        <div class="stat-details">
            <div class="stat-value" id="lowStock">0</div>
            <div class="stat-label">Low Stock Items</div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon red">‚ùå</div>
        <div class="stat-details">
            <div class="stat-value" id="outOfStock">0</div>
            <div class="stat-label">Out of Stock</div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon green">üì•</div>
        <div class="stat-details">
            <div class="stat-value" id="pendingReceipts">0</div>
            <div class="stat-label">Pending Receipts</div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon purple">üì§</div>
        <div class="stat-details">
            <div class="stat-value" id="pendingDeliveries">0</div>
            <div class="stat-label">Pending Deliveries</div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon teal">üîÑ</div>
        <div class="stat-details">
            <div class="stat-value" id="scheduledTransfers">0</div>
            <div class="stat-label">Scheduled Transfers</div>
        </div>
    </div>
</div>

<!-- Category Stats -->
<div class="card" style="margin-bottom: 30px;">
    <div class="card-header">
        <h3 class="card-title">Product Categories</h3>
    </div>
    <div id="categoriesGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; padding: 10px 0;">
        <p style="text-align: center; color: #7f8c8d;">Loading categories...</p>
    </div>
</div>

<div class="content-grid">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Recent Stock Movements</h3>
            <a href="/history" class="btn btn-secondary">View All</a>
        </div>
        <table class="table">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Type</th>
                    <th>Quantity</th>
                    <th>Warehouse</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody id="recentMovesTable">
                <tr>
                    <td colspan="5" style="text-align: center; padding: 30px; color: #7f8c8d;">
                        Loading movements...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Low Stock Alerts</h3>
        </div>
        <div id="lowStockAlerts">
            <p style="text-align: center; padding: 30px; color: #7f8c8d;">Loading alerts...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    async function loadDashboard() {
        try {
            // Get token first
            const token = localStorage.getItem('access_token');
            
            // If no token, don't try to load data (user will see zeros)
            if (!token) {
                console.log('No token found - user needs to login');
                return;
            }

            // Make API call
            const response = await apiCall('/api/dashboard');
            
            // If apiCall redirected (no response), stop here
            if (!response) {
                return;
            }

            const data = await response.json();

            // Update KPIs - with safe fallback values
            document.getElementById('totalProducts').textContent = data.kpis?.total_products || 0;
            document.getElementById('lowStock').textContent = data.kpis?.low_stock_items || 0;
            document.getElementById('outOfStock').textContent = data.kpis?.out_of_stock_items || 0;
            document.getElementById('pendingReceipts').textContent = data.kpis?.pending_receipts || 0;
            document.getElementById('pendingDeliveries').textContent = data.kpis?.pending_deliveries || 0;
            document.getElementById('scheduledTransfers').textContent = data.kpis?.scheduled_transfers || 0;

            // Load recent moves - with null checks
            const movesTable = document.getElementById('recentMovesTable');
            if (!data.recent_moves || data.recent_moves.length === 0) {
                movesTable.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 30px; color: #7f8c8d;">No recent movements</td></tr>';
            } else {
                movesTable.innerHTML = data.recent_moves.map(move => `
                    <tr>
                        <td>${move.product?.name || 'Unknown'}</td>
                        <td><span class="badge badge-info">${move.move_type || 'N/A'}</span></td>
                        <td>${move.quantity > 0 ? '+' : ''}${move.quantity || 0}</td>
                        <td>${move.warehouse?.name || 'Unknown'}</td>
                        <td>${move.move_date ? new Date(move.move_date).toLocaleDateString() : 'N/A'}</td>
                    </tr>
                `).join('');
            }

            // Load low stock alerts - with null checks
            const alertsDiv = document.getElementById('lowStockAlerts');
            if (!data.low_stock_alerts || data.low_stock_alerts.length === 0) {
                alertsDiv.innerHTML = '<p style="text-align: center; padding: 30px; color: #7f8c8d;">All stock levels are good! üéâ</p>';
            } else {
                alertsDiv.innerHTML = data.low_stock_alerts.map(alert => `
                    <div class="alert-item">
                        <div class="alert-text">
                            <div class="alert-title">${alert.product?.name || 'Unknown Product'}</div>
                            <div class="alert-desc">${alert.warehouse?.name || 'Unknown'} - Available: ${alert.available_quantity || 0} / Reorder: ${alert.product?.reorder_level || 0}</div>
                        </div>
                        <span class="badge badge-warning">Low</span>
                    </div>
                `).join('');
            }
        } catch (error) {
            console.error('Error loading dashboard:', error);
            // Show error message but don't redirect
            document.getElementById('recentMovesTable').innerHTML = 
                '<tr><td colspan="5" style="text-align: center; padding: 30px; color: #e74c3c;">Unable to load dashboard data. Please check your connection.</td></tr>';
        }
    }

    // Load dashboard when page is ready
    window.addEventListener('DOMContentLoaded', () => {
        loadCategories();
        loadDashboard();
    });
</script>
{% endblock %}